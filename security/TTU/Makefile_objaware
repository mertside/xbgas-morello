#
# BSD Make obj-directory-aware Makefile for xBGAS TTU Memory Safety Tests
#

# Basic Configuration
CC ?= cc
CFLAGS = -g -O2 -Wall -Wextra -std=c99 -I../../runtime
LDFLAGS = -lpthread -lm
COMPILE = $(CC) $(CFLAGS) $(LDFLAGS)

# Auto-detect if we're in obj directory (BSD make behavior)
# If current directory contains no .c files but parent does, we're in obj
CURRENT_C_FILES != ls -1 *.c 2>/dev/null | wc -l
PARENT_C_FILES != ls -1 ../*.c 2>/dev/null | wc -l

# Set source directory based on detection
.if $(CURRENT_C_FILES) == 0 && $(PARENT_C_FILES) > 0
SRCDIR = ..
RTDIR = ../../../runtime
.else
SRCDIR = .
RTDIR = ../../runtime
.endif

# Update CFLAGS with correct runtime path
CFLAGS = -g -O2 -Wall -Wextra -std=c99 -I$(RTDIR)

# Assembly source file
ASM_SOURCE = $(RTDIR)/xbMrtime_api_asm.s

# Compilation command - include assembly if it exists
.if exists($(ASM_SOURCE))
COMPILE = $(CC) $(CFLAGS) $(LDFLAGS) $(ASM_SOURCE)
.else
COMPILE = $(CC) $(CFLAGS) $(LDFLAGS)
.endif

# Output Directory
REPORTDIR = ./reports

# Test Sources with auto-detected source directory
SPATIAL_SOURCES = \
	$(SRCDIR)/ttu_s1_free_not_at_start_refactored.c \
	$(SRCDIR)/ttu_s2_free_not_on_heap_refactored.c \
	$(SRCDIR)/ttu_s3_null_ptr_dereference_refactored.c \
	$(SRCDIR)/ttu_s4_oob_read_refactored.c \
	$(SRCDIR)/ttu_s5_oob_write_refactored.c

TEMPORAL_SOURCES = \
	$(SRCDIR)/ttu_t1_double_free_refactored.c \
	$(SRCDIR)/ttu_t2_hm_fake_chunk_malloc_refactored.c \
	$(SRCDIR)/ttu_t3_hm_house_of_spirit_refactored.c \
	$(SRCDIR)/ttu_t4_hm_p_and_c_chunk_refactored.c \
	$(SRCDIR)/ttu_t5_use_after_free_refactored.c \
	$(SRCDIR)/ttu_t6_uaf_function_pointer_refactored_fixed.c \
	$(SRCDIR)/ttu_t7_uaf_memcpy_refactored.c

REALWORLD_SOURCES = \
	$(SRCDIR)/ttu_r1_HeartBleed_refactored.c \
	$(SRCDIR)/ttu_r2_dop_refactored.c \
	$(SRCDIR)/ttu_r3_uaf_to_code_reuse_refactored.c \
	$(SRCDIR)/ttu_r4_illegal_ptr_deref_refactored.c \
	$(SRCDIR)/ttu_r5_df_switch_refactored.c

HEAP_SOURCES = \
	$(SRCDIR)/ttu_t2_hm_fake_chunk_malloc_refactored.c \
	$(SRCDIR)/ttu_t3_hm_house_of_spirit_refactored.c \
	$(SRCDIR)/ttu_t4_hm_p_and_c_chunk_refactored.c

# ============================================================================
#                              BUILD TARGETS  
# ============================================================================

all: check-environment spatial temporal realworld
	@echo "===================================================="
	@echo "All TTU refactored tests built successfully!"
	@echo "===================================================="

check-environment:
	@echo "=== Environment Check ==="
	@echo "Compiler: $(CC)"
	@echo "Working directory: `pwd`"
	@echo "Source directory: $(SRCDIR)"
	@echo "Runtime directory: $(RTDIR)"
	@echo "Assembly source: $(ASM_SOURCE)"
	@echo "Available refactored files in source dir:"
	@ls -1 $(SRCDIR)/*_refactored*.c 2>/dev/null | wc -l | sed 's/^/  Found: /' || echo "  Found: 0"
	@echo "Runtime directory exists: `test -d $(RTDIR) && echo YES || echo NO`"
	@echo "Assembly source exists: `test -f $(ASM_SOURCE) && echo YES || echo NO`"
.if !exists($(ASM_SOURCE))
	@echo "⚠ WARNING: Assembly source not found - some tests may fail to link"
	@echo "  Expected: $(ASM_SOURCE)"
.endif
	@mkdir -p $(REPORTDIR)

spatial: check-environment
	@echo "=== Building Spatial Safety Tests ==="
	@for src in $(SPATIAL_SOURCES); do \
		if test -f "$$src"; then \
			target=`basename $$src .c`.exe; \
			echo "Building $$target from $$src..."; \
			if $(COMPILE) -o $$target $$src > $(REPORTDIR)/build_$$target.log 2>&1; then \
				echo "  ✓ Built $$target"; \
			else \
				echo "  ✗ Failed to build $$target"; \
				echo "  Error details:"; \
				cat $(REPORTDIR)/build_$$target.log | sed 's/^/    /'; \
				exit 1; \
			fi; \
		else \
			echo "  ⚠ Missing source file: $$src"; \
		fi; \
	done

temporal: check-environment
	@echo "=== Building Temporal Safety Tests ==="
	@for src in $(TEMPORAL_SOURCES); do \
		if test -f "$$src"; then \
			target=`basename $$src .c`.exe; \
			echo "Building $$target from $$src..."; \
			if $(COMPILE) -o $$target $$src > $(REPORTDIR)/build_$$target.log 2>&1; then \
				echo "  ✓ Built $$target"; \
			else \
				echo "  ✗ Failed to build $$target"; \
				echo "  Error details:"; \
				cat $(REPORTDIR)/build_$$target.log | sed 's/^/    /'; \
				exit 1; \
			fi; \
		else \
			echo "  ⚠ Missing source file: $$src"; \
		fi; \
	done

realworld: check-environment
	@echo "=== Building Real-World Tests ==="
	@for src in $(REALWORLD_SOURCES); do \
		if test -f "$$src"; then \
			target=`basename $$src .c`.exe; \
			echo "Building $$target from $$src..."; \
			if $(COMPILE) -o $$target $$src > $(REPORTDIR)/build_$$target.log 2>&1; then \
				echo "  ✓ Built $$target"; \
			else \
				echo "  ✗ Failed to build $$target"; \
				echo "  Error details:"; \
				cat $(REPORTDIR)/build_$$target.log | sed 's/^/    /'; \
				exit 1; \
			fi; \
		else \
			echo "  ⚠ Missing source file: $$src"; \
		fi; \
	done

heap: check-environment
	@echo "=== Building Heap Manipulation Tests ==="
	@for src in $(HEAP_SOURCES); do \
		if test -f "$$src"; then \
			target=`basename $$src .c`.exe; \
			echo "Building $$target from $$src..."; \
			if $(COMPILE) -o $$target $$src > $(REPORTDIR)/build_$$target.log 2>&1; then \
				echo "  ✓ Built $$target"; \
			else \
				echo "  ✗ Failed to build $$target"; \
				echo "  Error details:"; \
				cat $(REPORTDIR)/build_$$target.log | sed 's/^/    /'; \
				exit 1; \
			fi; \
		else \
			echo "  ⚠ Missing source file: $$src"; \
		fi; \
	done

# ============================================================================
#                              TEST EXECUTION
# ============================================================================

run-spatial: spatial
	@echo "=== Running Spatial Safety Tests ==="
	@for src in $(SPATIAL_SOURCES); do \
		target=`basename $$src .c`.exe; \
		if test -f "$$target"; then \
			echo "Running $$target..."; \
			./$$target > $(REPORTDIR)/run_$$target.log 2>&1 && \
				echo "  ✓ $$target completed" || echo "  ✗ $$target failed"; \
		fi; \
	done

run-temporal: temporal
	@echo "=== Running Temporal Safety Tests ==="
	@for src in $(TEMPORAL_SOURCES); do \
		target=`basename $$src .c`.exe; \
		if test -f "$$target"; then \
			echo "Running $$target..."; \
			./$$target > $(REPORTDIR)/run_$$target.log 2>&1 && \
				echo "  ✓ $$target completed" || echo "  ✗ $$target failed"; \
		fi; \
	done

run-realworld: realworld
	@echo "=== Running Real-World Tests ==="
	@for src in $(REALWORLD_SOURCES); do \
		target=`basename $$src .c`.exe; \
		if test -f "$$target"; then \
			echo "Running $$target..."; \
			./$$target > $(REPORTDIR)/run_$$target.log 2>&1 && \
				echo "  ✓ $$target completed" || echo "  ✗ $$target failed"; \
		fi; \
	done

run-all: all
	@echo "========================================================="
	@echo "Running comprehensive TTU security test suite"
	@echo "========================================================="
	@$(MAKE) run-spatial
	@$(MAKE) run-temporal
	@$(MAKE) run-realworld

# ============================================================================
#                              VALIDATION
# ============================================================================

check-files:
	@echo "=== File Check ==="
	@echo "Source directory: $(SRCDIR)"
	@echo "Spatial sources (expected 5):"
	@for src in $(SPATIAL_SOURCES); do \
		test -f "$$src" && echo "  ✓ $$src" || echo "  ✗ $$src (missing)"; \
	done
	@echo "Temporal sources (expected 7):"
	@for src in $(TEMPORAL_SOURCES); do \
		test -f "$$src" && echo "  ✓ $$src" || echo "  ✗ $$src (missing)"; \
	done
	@echo "Real-world sources (expected 5):"
	@for src in $(REALWORLD_SOURCES); do \
		test -f "$$src" && echo "  ✓ $$src" || echo "  ✗ $$src (missing)"; \
	done

compile-test:
	@echo "=== Compilation Test ==="
	@echo "Testing single file compilation..."
	@test_file="$(SRCDIR)/ttu_s1_free_not_at_start_refactored.c"; \
	if test -f "$$test_file"; then \
		echo "Compiling $$test_file..."; \
		$(COMPILE) -o test_compile.exe $$test_file && \
			{ echo "✓ Compilation successful"; rm -f test_compile.exe; } || \
			echo "✗ Compilation failed"; \
	else \
		echo "✗ Test file not found: $$test_file"; \
	fi

# ============================================================================
#                              MAINTENANCE
# ============================================================================

clean:
	@echo "Cleaning generated files..."
	@rm -f *.exe *.o *.core
	@rm -rf $(REPORTDIR)

clean-logs:
	@rm -rf $(REPORTDIR)
	@mkdir -p $(REPORTDIR)

# ============================================================================
#                                 HELP
# ============================================================================

config:
	@echo "=== Build Configuration ==="
	@echo "CC = $(CC)"
	@echo "CFLAGS = $(CFLAGS)"
	@echo "LDFLAGS = $(LDFLAGS)"
	@echo "COMPILE = $(COMPILE)"
	@echo "SRCDIR = $(SRCDIR)"
	@echo "RTDIR = $(RTDIR)"
	@echo "REPORTDIR = $(REPORTDIR)"
	@echo "PWD = `pwd`"

help:
	@echo "TTU Memory Safety Tests - BSD Make obj-aware Build System"
	@echo "========================================================="
	@echo "This Makefile automatically handles BSD make's obj directory behavior"
	@echo ""
	@echo "ENVIRONMENT:"
	@echo "  check-environment - Show build environment"
	@echo "  config           - Show build configuration"
	@echo "  check-files      - Verify source files exist"
	@echo ""
	@echo "BUILD TARGETS:"
	@echo "  all        - Build all refactored tests"
	@echo "  spatial    - Build spatial safety tests (5)"
	@echo "  temporal   - Build temporal safety tests (7)"
	@echo "  realworld  - Build real-world tests (5)"
	@echo "  heap       - Build heap manipulation tests (3)"
	@echo ""
	@echo "TEST TARGETS:"
	@echo "  run-all      - Run all tests"
	@echo "  run-spatial  - Run spatial tests"
	@echo "  run-temporal - Run temporal tests"
	@echo "  run-realworld- Run real-world tests"
	@echo ""
	@echo "VALIDATION:"
	@echo "  compile-test - Test single file compilation"
	@echo ""
	@echo "MAINTENANCE:"
	@echo "  clean      - Remove generated files"
	@echo "  clean-logs - Clean only log files"
	@echo "  help       - Show this help"

# Mark all targets as PHONY that don't create files
.PHONY: all check-environment spatial temporal realworld heap
.PHONY: run-spatial run-temporal run-realworld run-all
.PHONY: check-files compile-test clean clean-logs config help

# EOF
