#
# Minimal Makefile for testing xBGAS Memory Safety Tests
#

# Basic Configuration
CC = cc
CFLAGS = -g -O2 -Wall -Wextra -std=c99
LDFLAGS = -lpthread -lm

# Try to include runtime headers if available
INCLUDES = -I../../runtime
ifneq (,$(wildcard ../../runtime/xbMrtime_api_asm.s))
  COMPILE = $(CC) $(CFLAGS) $(INCLUDES) $(LDFLAGS) ../../runtime/xbMrtime_api_asm.s
else
  COMPILE = $(CC) $(CFLAGS) $(INCLUDES) $(LDFLAGS)
endif

# Test Sources (just a few for testing)
TEST_SOURCES = \
	ttu_s1_free_not_at_start_refactored.c \
	ttu_s4_oob_read_refactored.c \
	ttu_t1_double_free_refactored.c

TEST_TARGETS = $(TEST_SOURCES:.c=.exe)

# Default target
.PHONY: all
all: $(TEST_TARGETS)
	@echo "Built $(words $(TEST_TARGETS)) test executables"

# Simple compilation rule
%.exe: %.c
	@echo "Building $@ from $<"
	$(COMPILE) -o $@ $<
	@echo "Successfully built $@"

# Test execution
.PHONY: test
test: all
	@echo "Running tests..."
	@for test in $(TEST_TARGETS); do \
		echo "Running $$test..."; \
		./$$test && echo "PASSED" || echo "FAILED"; \
	done

# Clean up
.PHONY: clean
clean:
	rm -f *.exe

# Show configuration
.PHONY: config
config:
	@echo "CC = $(CC)"
	@echo "CFLAGS = $(CFLAGS)"
	@echo "LDFLAGS = $(LDFLAGS)"
	@echo "INCLUDES = $(INCLUDES)"
	@echo "COMPILE = $(COMPILE)"
	@echo "TEST_SOURCES = $(TEST_SOURCES)"
	@echo "TEST_TARGETS = $(TEST_TARGETS)"

.PHONY: help
help:
	@echo "Minimal Test Makefile"
	@echo "Targets:"
	@echo "  all     - Build test executables"
	@echo "  test    - Run tests"
	@echo "  clean   - Clean up"
	@echo "  config  - Show configuration"
	@echo "  help    - Show this help"

# EOF
